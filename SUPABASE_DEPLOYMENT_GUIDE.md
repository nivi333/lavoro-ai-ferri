# Supabase + Render Deployment Guide for Lavoro AI Ferri

## Overview
This guide covers deploying the Lavoro AI Ferri backend to Render with Supabase as the PostgreSQL database provider.

## Prerequisites
- Supabase account with a project created
- Render account
- Your Supabase connection strings ready

---

## 1. Supabase Database Setup

### Get Your Connection Strings

From your Supabase project dashboard:

1. Go to **Settings** → **Database**
2. Find the **Connection String** section
3. You'll need TWO different connection strings:

#### A. Transaction Pooler (for DATABASE_URL)
```
postgresql://postgres.[PROJECT-REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:6543/postgres?pgbouncer=true&sslmode=require
```
- **Port**: 6543
- **Use for**: Application queries (better performance)
- **PgBouncer**: Transaction mode pooling

#### B. Direct Connection (for DIRECT_URL)
```
postgresql://postgres.[PROJECT-REF]:[PASSWORD]@db.[PROJECT-REF].supabase.co:5432/postgres?sslmode=require
```
- **Port**: 5432
- **Use for**: Prisma migrations only
- **Direct**: No pooling (required for migrations)

### Important Notes:
- Replace `[PROJECT-REF]` with your actual Supabase project reference
- Replace `[PASSWORD]` with your database password
- Replace `[REGION]` with your region (e.g., `us-east-1`)
- **Always include** `?sslmode=require` for security

---

## 2. Render Deployment Configuration

### A. Environment Variables in Render Dashboard

After deploying to Render, set these environment variables in the Render Dashboard:

#### Required Database Variables:
```bash
DATABASE_URL=postgresql://postgres.[PROJECT-REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:6543/postgres?pgbouncer=true&sslmode=require

DIRECT_URL=postgresql://postgres.[PROJECT-REF]:[PASSWORD]@db.[PROJECT-REF].supabase.co:5432/postgres?sslmode=require
```

#### Other Required Variables:
```bash
NODE_ENV=production
PORT=3000
HOST=0.0.0.0
DB_MAX_CONNECTIONS=20
DB_IDLE_TIMEOUT=30000
DB_CONNECTION_TIMEOUT=5000
CORS_ORIGIN=https://YOUR-NETLIFY-SUBDOMAIN.netlify.app
API_VERSION=v1
API_PREFIX=/api
BCRYPT_ROUNDS=12
```

#### Auto-Generated Variables (Render handles these):
- `JWT_SECRET` - Auto-generated by Render
- `JWT_REFRESH_SECRET` - Auto-generated by Render
- `SESSION_SECRET` - Auto-generated by Render
- `REDIS_URL` - From Render Redis service

### B. Deployment Steps

1. **Push your code to GitHub** (if not already done)
   ```bash
   git add .
   git commit -m "Configure Supabase database"
   git push origin main
   ```

2. **Connect Render to your repository**
   - Go to Render Dashboard
   - Click "New" → "Blueprint"
   - Connect your GitHub repository
   - Render will read `render.yaml` automatically

3. **Set Database Environment Variables**
   - Go to your web service in Render
   - Navigate to "Environment" tab
   - Add `DATABASE_URL` and `DIRECT_URL` with your Supabase connection strings

4. **Deploy**
   - Render will automatically deploy
   - Pre-deploy command runs: `npx prisma migrate deploy`
   - This applies all migrations to your Supabase database

---

## 3. Prisma Configuration (Already Set Up)

Your `prisma/schema.prisma` is already configured correctly:

```prisma
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")      // Uses pooler for queries
  directUrl = env("DIRECT_URL")        // Uses direct connection for migrations
}
```

**Why two URLs?**
- `DATABASE_URL`: Pooled connection (PgBouncer) for better performance
- `DIRECT_URL`: Direct connection required for schema migrations

---

## 4. Connection Pooling Configuration

### Supabase Pooler Modes

Supabase offers three pooler modes:

1. **Transaction Mode** (Recommended - Already configured)
   - Port: 6543
   - Best for serverless/stateless applications
   - Each transaction gets a connection
   - URL includes: `?pgbouncer=true`

2. **Session Mode**
   - Port: 6543
   - One connection per client session
   - Use if you need prepared statements

3. **Direct Connection**
   - Port: 5432
   - No pooling
   - Required for migrations

### Your Current Setup:
- ✅ Application uses Transaction Mode (port 6543)
- ✅ Migrations use Direct Connection (port 5432)
- ✅ SSL enabled (`sslmode=require`)
- ✅ Connection pool: 20 max connections

---

## 5. Testing Your Deployment

### A. Test Database Connection

After deployment, check Render logs:

```bash
# Look for successful connection messages:
✓ Prisma migrate deploy completed
✓ Database connected successfully
✓ Server running on port 3000
```

### B. Test API Endpoints

```bash
# Health check
curl https://your-app.onrender.com/health

# API test
curl https://your-app.onrender.com/api/v1/health
```

### C. Test Migrations

Migrations run automatically during deployment via:
```bash
npx prisma migrate deploy
```

Check Render logs for migration success.

---

## 6. Local Development with Supabase

If you want to use Supabase for local development:

### Update `.env`:
```bash
# Use Supabase pooler for development
DATABASE_URL=postgresql://postgres.[PROJECT-REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:6543/postgres?pgbouncer=true&sslmode=require

# Use direct connection for migrations
DIRECT_URL=postgresql://postgres.[PROJECT-REF]:[PASSWORD]@db.[PROJECT-REF].supabase.co:5432/postgres?sslmode=require

DB_SSL=true
```

### Run Migrations:
```bash
npx prisma migrate deploy
```

---

## 7. Troubleshooting

### Issue: "prepared statement already exists"
**Solution**: You're using session mode instead of transaction mode
- Ensure `?pgbouncer=true` is in DATABASE_URL
- Use port 6543, not 5432

### Issue: "Migration failed"
**Solution**: DIRECT_URL not set or incorrect
- Verify DIRECT_URL uses port 5432
- Ensure no `?pgbouncer=true` in DIRECT_URL

### Issue: "SSL connection required"
**Solution**: Add SSL mode to connection strings
- Append `?sslmode=require` to both URLs
- Or use `&sslmode=require` if other params exist

### Issue: "Too many connections"
**Solution**: Adjust connection pool settings
- Reduce `DB_MAX_CONNECTIONS` in Render env vars
- Check Supabase connection limits in dashboard

### Issue: "Connection timeout"
**Solution**: Check network/firewall settings
- Verify Supabase project is active
- Check Render can access Supabase (should work by default)
- Increase `DB_CONNECTION_TIMEOUT` if needed

---

## 8. Monitoring & Maintenance

### Supabase Dashboard
- Monitor database size and connections
- View query performance
- Check connection pooler stats
- Set up alerts for high usage

### Render Dashboard
- Monitor deployment logs
- Check memory/CPU usage
- View application logs
- Set up health check alerts

### Database Backups
Supabase provides:
- Automatic daily backups (retained based on plan)
- Point-in-time recovery (paid plans)
- Manual backup via pg_dump

---

## 9. Security Best Practices

✅ **Implemented:**
- SSL/TLS encryption (`sslmode=require`)
- Connection pooling (prevents connection exhaustion)
- Environment variable secrets (not in code)
- JWT token authentication
- Rate limiting
- CORS configuration

⚠️ **Recommended:**
- Enable Supabase Row Level Security (RLS) if needed
- Rotate database passwords regularly
- Monitor for suspicious connection patterns
- Set up database connection alerts

---

## 10. Performance Optimization

### Connection Pooling
- Current: 20 max connections
- Adjust based on Render plan and Supabase limits
- Transaction mode is optimal for stateless apps

### Query Optimization
- Use Prisma query optimization
- Add database indexes for frequently queried fields
- Monitor slow queries in Supabase dashboard

### Caching
- Redis already configured for session caching
- Consider query result caching for read-heavy operations

---

## Summary Checklist

Before deploying to production:

- [ ] Supabase project created
- [ ] Connection strings copied (pooler + direct)
- [ ] `render.yaml` updated (already done)
- [ ] Environment variables set in Render Dashboard
- [ ] `DATABASE_URL` uses port 6543 with `?pgbouncer=true&sslmode=require`
- [ ] `DIRECT_URL` uses port 5432 with `?sslmode=require`
- [ ] Frontend `CORS_ORIGIN` updated in Render env vars
- [ ] Test deployment successful
- [ ] Migrations applied successfully
- [ ] API endpoints responding
- [ ] Health checks passing

---

## Support Resources

- **Supabase Docs**: https://supabase.com/docs/guides/database
- **Render Docs**: https://render.com/docs
- **Prisma + Supabase**: https://www.prisma.io/docs/guides/database/supabase

---

**Deployment Status**: ✅ Configuration Complete

Your codebase is now properly configured for Supabase + Render deployment. Follow the steps above to deploy successfully.
