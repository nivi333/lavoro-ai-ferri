generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model companies {
  id                String              @id
  company_id        String              @unique
  name              String
  slug              String              @unique
  industry          String?
  description       String?
  logo_url          String?
  website           String?
  tax_id            String?
  email             String?
  phone             String?
  address_line_1    String?
  address_line_2    String?
  city              String?
  state             String?
  country           String?
  pincode           String?
  contact_info      Json?
  established_date  DateTime?
  business_type     String?
  certifications    String[]
  is_active         Boolean             @default(true)
  created_at        DateTime            @default(now())
  updated_at        DateTime
  default_location  String?
  company_locations company_locations[]
  user_companies    user_companies[]
  orders            orders[]            @relation("CompanyOrders")
  financial_documents financial_documents[]
  quality_checkpoints quality_checkpoints[]
  quality_defects   quality_defects[]
  quality_metrics   quality_metrics[]
  compliance_reports compliance_reports[]
}

model company_locations {
  id              String       @id
  location_id     String       @unique
  company_id      String
  name            String
  is_default      Boolean      @default(false)
  is_headquarters Boolean      @default(false)
  location_type   LocationType @default(BRANCH)
  is_active       Boolean      @default(true)
  created_at      DateTime     @default(now())
  updated_at      DateTime
  address_line_1  String
  address_line_2  String?
  city            String
  state           String
  country         String
  contact_info    Json?
  email           String?
  phone           String?
  pincode         String?
  image_url       String?
  companies       companies    @relation(fields: [company_id], references: [id], onDelete: Cascade)
  orders          orders[]     @relation("LocationOrders")
  financial_documents financial_documents[]
  quality_checkpoints quality_checkpoints[]
}

model sessions {
  id         String   @id
  user_id    String
  company_id String?
  token      String   @unique
  is_active  Boolean  @default(true)
  expires_at DateTime
  created_at DateTime @default(now())
  updated_at DateTime
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model user_companies {
  id         String    @id
  user_id    String
  company_id String
  role       Role      @default(EMPLOYEE)
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now())
  updated_at DateTime
  companies  companies @relation(fields: [company_id], references: [id], onDelete: Cascade)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, company_id])
}

model users {
  id             String           @id
  first_name     String
  last_name      String
  email          String?          @unique
  phone          String?          @unique
  password       String
  is_active      Boolean          @default(true)
  created_at     DateTime         @default(now())
  updated_at     DateTime
  sessions       sessions[]
  user_companies user_companies[]
}

enum LocationType {
  BRANCH
  WAREHOUSE
  FACTORY
  STORE
}

enum Role {
  OWNER
  ADMIN
  MANAGER
  EMPLOYEE
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  IN_PRODUCTION
  READY_TO_SHIP
  SHIPPED
  DELIVERED
  CANCELLED
}

enum DocumentType {
  INVOICE
  BILL
  PURCHASE_ORDER
}

model orders {
  id              String        @id
  order_id        String        @unique
  company_id      String
  customer_name   String
  customer_code   String?
  status          OrderStatus   @default(DRAFT)
  order_date      DateTime
  delivery_date   DateTime?
  currency        String        @default("INR")
  total_amount    Decimal       @db.Decimal(12, 2)
  notes           String?
  location_id     String?
  shipping_carrier       String?
  tracking_number        String?
  shipping_method        String?
  delivery_window_start  DateTime?
  delivery_window_end    DateTime?
  created_at      DateTime      @default(now())
  updated_at      DateTime

  company         companies      @relation("CompanyOrders", fields: [company_id], references: [id], onDelete: Cascade)
  location        company_locations? @relation("LocationOrders", fields: [location_id], references: [id])
  order_items     order_items[]
  financial_documents financial_documents[] @relation("OrderFinancialDocuments")
  quality_checkpoints quality_checkpoints[]
}

model order_items {
  id              String   @id
  order_id        String
  line_number     Int
  item_code       String
  description     String?
  quantity        Decimal  @db.Decimal(12, 3)
  unit_of_measure String
  unit_price      Decimal  @db.Decimal(12, 2)
  line_amount     Decimal  @db.Decimal(12, 2)

  orders          orders   @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@unique([order_id, line_number])
}

model financial_documents {
  id              String        @id
  document_id     String        @unique
  company_id      String
  location_id     String
  order_id        String?
  document_type   DocumentType
  party_name      String
  party_code      String?
  issue_date      DateTime
  due_date        DateTime?
  currency        String        @default("INR")
  subtotal_amount Decimal       @db.Decimal(12, 2)
  tax_amount      Decimal       @db.Decimal(12, 2)
  total_amount    Decimal       @db.Decimal(12, 2)
  notes           String?
  created_at      DateTime      @default(now())
  updated_at      DateTime

  company         companies         @relation(fields: [company_id], references: [id], onDelete: Cascade)
  location        company_locations @relation(fields: [location_id], references: [id])
  order           orders?           @relation("OrderFinancialDocuments", fields: [order_id], references: [id], onDelete: SetNull)
}

// Quality Control System Tables

model quality_checkpoints {
  id              String         @id @default(uuid())
  checkpoint_id   String         @unique
  company_id      String
  location_id     String?
  order_id        String?
  checkpoint_type CheckpointType
  checkpoint_name String
  inspector_name  String
  inspection_date DateTime
  status          QCStatus
  overall_score   Decimal?       @db.Decimal(5, 2)
  notes           String?
  created_at      DateTime       @default(now())
  updated_at      DateTime

  company companies          @relation(fields: [company_id], references: [id], onDelete: Cascade)
  location company_locations? @relation(fields: [location_id], references: [id])
  order   orders?            @relation(fields: [order_id], references: [id])
  defects quality_defects[]
  metrics quality_metrics[]

  @@index([company_id])
  @@index([checkpoint_type])
  @@index([status])
}

enum CheckpointType {
  INCOMING_MATERIAL
  IN_PROCESS
  FINAL_INSPECTION
  PACKAGING
  RANDOM_SAMPLING
}

enum QCStatus {
  PENDING
  IN_PROGRESS
  PASSED
  FAILED
  CONDITIONAL_PASS
  REWORK_REQUIRED
}

model quality_defects {
  id                String           @id @default(uuid())
  defect_id         String           @unique
  company_id        String
  checkpoint_id     String
  defect_category   DefectCategory
  defect_type       String
  severity          DefectSeverity
  quantity          Int
  description       String?
  image_url         String?
  resolution_status ResolutionStatus
  resolution_notes  String?
  resolved_by       String?
  resolved_at       DateTime?
  created_at        DateTime         @default(now())
  updated_at        DateTime

  company    companies           @relation(fields: [company_id], references: [id], onDelete: Cascade)
  checkpoint quality_checkpoints @relation(fields: [checkpoint_id], references: [id])

  @@index([company_id])
  @@index([defect_category])
  @@index([severity])
  @@index([resolution_status])
}

enum DefectCategory {
  FABRIC
  STITCHING
  COLOR
  MEASUREMENT
  PACKAGING
  FINISHING
  LABELING
}

enum DefectSeverity {
  CRITICAL
  MAJOR
  MINOR
}

enum ResolutionStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  REJECTED
}

model quality_metrics {
  id              String   @id @default(uuid())
  metric_id       String   @unique
  company_id      String
  checkpoint_id   String
  metric_name     String
  metric_value    Decimal  @db.Decimal(10, 4)
  unit_of_measure String
  min_threshold   Decimal? @db.Decimal(10, 4)
  max_threshold   Decimal? @db.Decimal(10, 4)
  is_within_range Boolean
  notes           String?
  created_at      DateTime @default(now())

  company    companies           @relation(fields: [company_id], references: [id], onDelete: Cascade)
  checkpoint quality_checkpoints @relation(fields: [checkpoint_id], references: [id])

  @@index([company_id])
  @@index([checkpoint_id])
}

model compliance_reports {
  id              String           @id @default(uuid())
  report_id       String           @unique
  company_id      String
  report_type     ComplianceType
  report_date     DateTime
  auditor_name    String
  certification   String?
  validity_period String?
  status          ComplianceStatus
  findings        String?
  recommendations String?
  document_url    String?
  created_at      DateTime         @default(now())
  updated_at      DateTime

  company companies @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@index([company_id])
  @@index([report_type])
  @@index([status])
}

enum ComplianceType {
  ISO_9001
  ISO_14001
  OEKO_TEX
  GOTS
  WRAP
  SA8000
  BSCI
  SEDEX
}

enum ComplianceStatus {
  COMPLIANT
  NON_COMPLIANT
  PENDING_REVIEW
  EXPIRED
}
