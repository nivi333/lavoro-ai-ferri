generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model companies {
  id                String              @id
  company_id        String              @unique
  name              String
  slug              String              @unique
  industry          IndustryType        @default(TEXTILE_MANUFACTURING)
  description       String?
  logo_url          String?
  website           String?
  tax_id            String?
  email             String?
  phone             String?
  address_line_1    String?
  address_line_2    String?
  city              String?
  state             String?
  country           String?
  pincode           String?
  contact_info      Json?
  established_date  DateTime?
  business_type     String?
  certifications    String[]
  is_active         Boolean             @default(true)
  created_at        DateTime            @default(now())
  updated_at        DateTime
  default_location  String?
  company_locations company_locations[]
  user_companies    user_companies[]
  user_invitations  user_invitations[]
  orders            orders[]            @relation("CompanyOrders")
  financial_documents financial_documents[]
  quality_checkpoints quality_checkpoints[]
  quality_defects   quality_defects[]
  quality_metrics   quality_metrics[]
  compliance_reports compliance_reports[]
  products          products[]
  product_categories product_categories[]
  fabric_production fabric_production[]
  yarn_manufacturing yarn_manufacturing[]
  dyeing_finishing  dyeing_finishing[]
  garment_manufacturing garment_manufacturing[]
  quality_inspections quality_inspections[]
  inspection_templates inspection_templates[]
  inspection_metrics inspection_metrics[]
  design_patterns   design_patterns[]
}

model company_locations {
  id              String       @id
  location_id     String       @unique
  company_id      String
  name            String
  is_default      Boolean      @default(false)
  is_headquarters Boolean      @default(false)
  location_type   LocationType @default(BRANCH)
  is_active       Boolean      @default(true)
  created_at      DateTime     @default(now())
  updated_at      DateTime
  address_line_1  String
  address_line_2  String?
  city            String
  state           String
  country         String
  contact_info    Json?
  email           String?
  phone           String?
  pincode         String?
  image_url       String?
  companies       companies    @relation(fields: [company_id], references: [id], onDelete: Cascade)
  orders          orders[]     @relation("LocationOrders")
  financial_documents financial_documents[]
  quality_checkpoints quality_checkpoints[]
  fabric_production fabric_production[]
  yarn_manufacturing yarn_manufacturing[]
  dyeing_finishing  dyeing_finishing[]
  garment_manufacturing garment_manufacturing[]
}

model sessions {
  id         String   @id
  user_id    String
  company_id String?
  token      String   @unique
  is_active  Boolean  @default(true)
  expires_at DateTime
  created_at DateTime @default(now())
  updated_at DateTime
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model user_companies {
  id         String    @id
  user_id    String
  company_id String
  role       Role      @default(EMPLOYEE)
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now())
  updated_at DateTime
  companies  companies @relation(fields: [company_id], references: [id], onDelete: Cascade)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, company_id])
}

model users {
  id                      String           @id
  first_name              String
  last_name               String
  email                   String?          @unique
  phone                   String?          @unique
  password                String
  avatar_url              String?
  is_active               Boolean          @default(true)
  created_at              DateTime         @default(now())
  updated_at              DateTime
  sessions                sessions[]
  user_companies          user_companies[]
  invitations_sent        user_invitations[] @relation("InvitationSender")
  invitations_received    user_invitations[] @relation("InvitationReceiver")
  inspections             quality_inspections[] @relation("InspectionInspector")
  templates_created       inspection_templates[] @relation("TemplateCreator")
  defect_comments         defect_comments[] @relation("DefectCommentUser")
}

model user_invitations {
  id          String    @id
  user_id     String
  company_id  String
  invited_by  String
  role        String
  location_id String?
  status      String    @default("PENDING")
  created_at  DateTime  @default(now())
  updated_at  DateTime

  user        users     @relation("InvitationReceiver", fields: [user_id], references: [id], onDelete: Cascade)
  company     companies @relation(fields: [company_id], references: [id], onDelete: Cascade)
  inviter     users     @relation("InvitationSender", fields: [invited_by], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([company_id])
  @@index([status])
}

enum LocationType {
  BRANCH
  WAREHOUSE
  FACTORY
  STORE
}

enum Role {
  OWNER
  ADMIN
  MANAGER
  EMPLOYEE
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  IN_PRODUCTION
  READY_TO_SHIP
  SHIPPED
  DELIVERED
  CANCELLED
}

enum DocumentType {
  INVOICE
  BILL
  PURCHASE_ORDER
}

model orders {
  id              String        @id
  order_id        String        @unique
  company_id      String
  customer_name   String
  customer_code   String?
  status          OrderStatus   @default(DRAFT)
  order_date      DateTime
  delivery_date   DateTime?
  currency        String        @default("INR")
  total_amount    Decimal       @db.Decimal(12, 2)
  notes           String?
  location_id     String?
  shipping_carrier       String?
  tracking_number        String?
  shipping_method        String?
  delivery_window_start  DateTime?
  delivery_window_end    DateTime?
  created_at      DateTime      @default(now())
  updated_at      DateTime

  company         companies      @relation("CompanyOrders", fields: [company_id], references: [id], onDelete: Cascade)
  location        company_locations? @relation("LocationOrders", fields: [location_id], references: [id])
  order_items     order_items[]
  financial_documents financial_documents[] @relation("OrderFinancialDocuments")
  quality_checkpoints quality_checkpoints[]
  garment_manufacturing garment_manufacturing[]
}

model order_items {
  id              String   @id
  order_id        String
  line_number     Int
  item_code       String
  description     String?
  quantity        Decimal  @db.Decimal(12, 3)
  unit_of_measure String
  unit_price      Decimal  @db.Decimal(12, 2)
  line_amount     Decimal  @db.Decimal(12, 2)

  orders          orders   @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@unique([order_id, line_number])
}

model financial_documents {
  id              String        @id
  document_id     String        @unique
  company_id      String
  location_id     String
  order_id        String?
  document_type   DocumentType
  party_name      String
  party_code      String?
  issue_date      DateTime
  due_date        DateTime?
  currency        String        @default("INR")
  subtotal_amount Decimal       @db.Decimal(12, 2)
  tax_amount      Decimal       @db.Decimal(12, 2)
  total_amount    Decimal       @db.Decimal(12, 2)
  notes           String?
  created_at      DateTime      @default(now())
  updated_at      DateTime

  company         companies         @relation(fields: [company_id], references: [id], onDelete: Cascade)
  location        company_locations @relation(fields: [location_id], references: [id])
  order           orders?           @relation("OrderFinancialDocuments", fields: [order_id], references: [id], onDelete: SetNull)
}

// Quality Control System Tables

model quality_checkpoints {
  id              String         @id @default(uuid())
  checkpoint_id   String         @unique
  company_id      String
  location_id     String?
  order_id        String?
  product_id      String?
  checkpoint_type CheckpointType
  checkpoint_name String
  inspector_name  String
  inspection_date DateTime
  batch_number    String?
  total_batch     Int?
  lot_number      String?
  sample_size     Int?
  tested_quantity Int?
  status          QCStatus
  overall_score   Decimal?       @db.Decimal(5, 2)
  notes           String?
  created_at      DateTime       @default(now())
  updated_at      DateTime

  company companies          @relation(fields: [company_id], references: [id], onDelete: Cascade)
  location company_locations? @relation(fields: [location_id], references: [id])
  order   orders?            @relation(fields: [order_id], references: [id])
  product products?          @relation(fields: [product_id], references: [id])
  defects quality_defects[]
  metrics quality_metrics[]

  @@index([company_id])
  @@index([checkpoint_type])
  @@index([status])
  @@index([batch_number])
  @@index([product_id])
}

enum CheckpointType {
  INCOMING_MATERIAL
  IN_PROCESS
  FINAL_INSPECTION
  PACKAGING
  RANDOM_SAMPLING
  BATCH_TEST
}

enum QCStatus {
  PENDING
  IN_PROGRESS
  PASSED
  FAILED
  CONDITIONAL_PASS
  REWORK_REQUIRED
}

model quality_defects {
  id                String           @id @default(uuid())
  defect_id         String           @unique
  company_id        String
  checkpoint_id     String
  product_id        String?
  defect_category   DefectCategory
  defect_type       String
  severity          DefectSeverity
  quantity          Int
  batch_number      String?
  lot_number        String?
  affected_items    Int?
  description       String?
  image_url         String?
  resolution_status ResolutionStatus
  resolution_notes  String?
  resolved_by       String?
  resolved_at       DateTime?
  created_at        DateTime         @default(now())
  updated_at        DateTime

  company    companies           @relation(fields: [company_id], references: [id], onDelete: Cascade)
  checkpoint quality_checkpoints @relation(fields: [checkpoint_id], references: [id])
  product    products?           @relation("ProductDefects", fields: [product_id], references: [id])
  comments   defect_comments[]

  @@index([company_id])
  @@index([defect_category])
  @@index([severity])
  @@index([resolution_status])
  @@index([batch_number])
  @@index([product_id])
}

enum DefectCategory {
  FABRIC
  STITCHING
  COLOR
  MEASUREMENT
  PACKAGING
  FINISHING
  LABELING
}

enum DefectSeverity {
  CRITICAL
  MAJOR
  MINOR
}

enum ResolutionStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  REJECTED
}

model quality_metrics {
  id              String   @id @default(uuid())
  metric_id       String   @unique
  company_id      String
  checkpoint_id   String
  metric_name     String
  metric_value    Decimal  @db.Decimal(10, 4)
  unit_of_measure String
  min_threshold   Decimal? @db.Decimal(10, 4)
  max_threshold   Decimal? @db.Decimal(10, 4)
  is_within_range Boolean
  notes           String?
  created_at      DateTime @default(now())

  company    companies           @relation(fields: [company_id], references: [id], onDelete: Cascade)
  checkpoint quality_checkpoints @relation(fields: [checkpoint_id], references: [id])

  @@index([company_id])
  @@index([checkpoint_id])
}

model compliance_reports {
  id              String           @id @default(uuid())
  report_id       String           @unique
  report_code     String?          @unique
  company_id      String
  report_type     ComplianceType
  report_date     DateTime
  auditor_name    String
  certification   String?
  validity_period String?
  status          ComplianceStatus
  findings        String?
  recommendations String?
  document_url    String?
  created_at      DateTime         @default(now())
  updated_at      DateTime

  company companies @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@index([company_id])
  @@index([report_type])
  @@index([status])
}

enum ComplianceType {
  ISO_9001
  ISO_14001
  OEKO_TEX
  GOTS
  WRAP
  SA8000
  BSCI
  SEDEX
}

enum ComplianceStatus {
  COMPLIANT
  NON_COMPLIANT
  PENDING_REVIEW
  EXPIRED
}

// Product Management System Tables

model product_categories {
  id          String    @id @default(uuid())
  category_id String
  company_id  String
  name        String
  description String?
  parent_id   String?
  is_active   Boolean   @default(true)
  created_at  DateTime  @default(now())
  updated_at  DateTime

  company  companies @relation(fields: [company_id], references: [id], onDelete: Cascade)
  products products[]

  @@unique([company_id, category_id])
  @@index([company_id])
  @@index([parent_id])
}

model products {
  id              String         @id @default(uuid())
  product_id      String
  product_code    String
  company_id      String
  category_id     String?
  sku             String
  name            String
  description     String?
  product_type    ProductType    @default(OWN_MANUFACTURE)
  material        String?
  color           String?
  size            String?
  weight          Decimal?       @db.Decimal(10, 3)
  unit_of_measure String         @default("PCS")
  cost_price      Decimal        @db.Decimal(12, 2)
  selling_price   Decimal        @db.Decimal(12, 2)
  markup_percent  Decimal?       @db.Decimal(5, 2)
  stock_quantity  Int            @default(0)
  reorder_level   Int?
  barcode         String?
  image_url       String?
  specifications  Json?
  is_active       Boolean        @default(true)
  created_at      DateTime       @default(now())
  updated_at      DateTime

  company         companies           @relation(fields: [company_id], references: [id], onDelete: Cascade)
  category        product_categories? @relation(fields: [category_id], references: [id], onDelete: SetNull)
  stock_adjustments stock_adjustments[]
  quality_checkpoints quality_checkpoints[]
  quality_defects quality_defects[] @relation("ProductDefects")

  @@unique([company_id, product_id])
  @@unique([company_id, product_code])
  @@unique([company_id, sku])
  @@index([company_id])
  @@index([category_id])
  @@index([sku])
  @@index([product_code])
}

model stock_adjustments {
  id              String              @id @default(uuid())
  adjustment_id   String
  product_id      String
  company_id      String
  adjustment_type StockAdjustmentType
  quantity        Decimal             @db.Decimal(12, 3)
  previous_stock  Decimal             @db.Decimal(12, 3)
  new_stock       Decimal             @db.Decimal(12, 3)
  reason          String?
  notes           String?
  adjusted_by     String
  created_at      DateTime            @default(now())

  product products @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([company_id, adjustment_id])
  @@index([product_id])
  @@index([company_id])
  @@index([created_at])
}

enum StockAdjustmentType {
  ADD
  REMOVE
  SET
  SALE
  PURCHASE
  RETURN
  DAMAGE
  TRANSFER
}

enum ProductType {
  OWN_MANUFACTURE
  VENDOR_SUPPLIED
  OUTSOURCED
  RAW_MATERIAL
  FINISHED_GOODS
  SEMI_FINISHED
}

// ============================================
// TEXTILE-SPECIFIC FEATURES (Sprint 3.5)
// ============================================

model fabric_production {
  id              String   @id @default(uuid())
  fabric_id       String
  company_id      String
  location_id     String?
  fabric_type     FabricType
  fabric_name     String
  composition     String
  weight_gsm      Decimal  @db.Decimal(8, 2)
  width_inches    Decimal  @db.Decimal(6, 2)
  color           String
  pattern         String?
  finish_type     String?
  quantity_meters Decimal  @db.Decimal(10, 2)
  production_date DateTime
  batch_number    String
  quality_grade   QualityGrade
  notes           String?
  created_at      DateTime @default(now())
  updated_at      DateTime

  company  companies          @relation(fields: [company_id], references: [id], onDelete: Cascade)
  location company_locations? @relation(fields: [location_id], references: [id])

  @@unique([company_id, fabric_id])
  @@index([company_id])
  @@index([fabric_type])
  @@index([quality_grade])
}

enum FabricType {
  COTTON
  SILK
  WOOL
  POLYESTER
  NYLON
  LINEN
  RAYON
  SPANDEX
  BLEND
}

enum QualityGrade {
  A_GRADE
  B_GRADE
  C_GRADE
  REJECT
}

model yarn_manufacturing {
  id              String      @id @default(uuid())
  yarn_id         String
  company_id      String
  location_id     String?
  yarn_type       YarnType
  yarn_count      String
  twist_per_inch  Decimal?    @db.Decimal(6, 2)
  ply             Int
  color           String
  dye_lot         String?
  quantity_kg     Decimal     @db.Decimal(10, 2)
  production_date DateTime
  batch_number    String
  process_type    YarnProcess
  quality_grade   QualityGrade
  notes           String?
  created_at      DateTime    @default(now())
  updated_at      DateTime

  company  companies          @relation(fields: [company_id], references: [id], onDelete: Cascade)
  location company_locations? @relation(fields: [location_id], references: [id])

  @@unique([company_id, yarn_id])
  @@index([company_id])
  @@index([yarn_type])
  @@index([process_type])
}

enum YarnType {
  COTTON
  POLYESTER
  WOOL
  SILK
  ACRYLIC
  NYLON
  BLEND
}

enum YarnProcess {
  SPINNING
  WEAVING
  KNITTING
  TWISTING
}

model dyeing_finishing {
  id                String         @id @default(uuid())
  process_id        String
  company_id        String
  location_id       String?
  fabric_id         String?
  process_type      DyeingProcess
  color_code        String
  color_name        String
  dye_method        String?
  recipe_code       String?
  quantity_meters   Decimal        @db.Decimal(10, 2)
  process_date      DateTime
  batch_number      String
  machine_number    String?
  temperature_c     Decimal?       @db.Decimal(5, 2)
  duration_minutes  Int?
  quality_check     Boolean        @default(false)
  color_fastness    String?
  shrinkage_percent Decimal?       @db.Decimal(5, 2)
  notes             String?
  created_at        DateTime       @default(now())
  updated_at        DateTime

  company  companies          @relation(fields: [company_id], references: [id], onDelete: Cascade)
  location company_locations? @relation(fields: [location_id], references: [id])

  @@unique([company_id, process_id])
  @@index([company_id])
  @@index([process_type])
}

enum DyeingProcess {
  DYEING
  PRINTING
  FINISHING
  WASHING
  BLEACHING
  MERCERIZING
}

model garment_manufacturing {
  id               String          @id @default(uuid())
  garment_id       String
  company_id       String
  location_id      String?
  order_id         String?
  garment_type     GarmentType
  style_number     String
  size             String
  color            String
  fabric_id        String?
  quantity         Int
  production_stage ProductionStage
  cut_date         DateTime?
  sew_date         DateTime?
  finish_date      DateTime?
  pack_date        DateTime?
  operator_name    String?
  line_number      String?
  quality_passed   Boolean         @default(false)
  defect_count     Int             @default(0)
  notes            String?
  created_at       DateTime        @default(now())
  updated_at       DateTime

  company  companies          @relation(fields: [company_id], references: [id], onDelete: Cascade)
  location company_locations? @relation(fields: [location_id], references: [id])
  order    orders?            @relation(fields: [order_id], references: [id])

  @@unique([company_id, garment_id])
  @@index([company_id])
  @@index([garment_type])
  @@index([production_stage])
  @@index([order_id])
}

enum GarmentType {
  SHIRT
  T_SHIRT
  PANTS
  JEANS
  DRESS
  SKIRT
  JACKET
  COAT
  SWEATER
  SHORTS
  UNDERWEAR
  SOCKS
}

enum ProductionStage {
  CUTTING
  SEWING
  FINISHING
  QUALITY_CHECK
  PACKING
  COMPLETED
}

model design_patterns {
  id                String         @id @default(uuid())
  design_id         String
  company_id        String
  design_name       String
  design_category   DesignCategory
  designer_name     String?
  season            String?
  color_palette     String[]
  pattern_repeat    String?
  design_file_url   String?
  sample_image_url  String?
  status            DesignStatus
  notes             String?
  created_at        DateTime       @default(now())
  updated_at        DateTime

  company companies @relation(fields: [company_id], references: [id], onDelete: Cascade)

  @@unique([company_id, design_id])
  @@index([company_id])
  @@index([design_category])
  @@index([status])
}

enum DesignCategory {
  PRINT
  EMBROIDERY
  WEAVE
  KNIT
  APPLIQUE
  DIGITAL_PRINT
}

enum DesignStatus {
  CONCEPT
  APPROVED
  IN_PRODUCTION
  ARCHIVED
}

enum IndustryType {
  TEXTILE_MANUFACTURING
  GARMENT_PRODUCTION
  KNITTING_WEAVING
  FABRIC_PROCESSING
  APPAREL_DESIGN
  FASHION_RETAIL
  YARN_PRODUCTION
  DYEING_FINISHING
  HOME_TEXTILES
  TECHNICAL_TEXTILES
}

// New Quality Control Enums
enum InspectionType {
  INCOMING_MATERIAL
  IN_PROCESS
  FINAL_PRODUCT
  RANDOM_CHECK
}

enum InspectionStatus {
  PENDING
  IN_PROGRESS
  PASSED
  FAILED
  CONDITIONAL
}

enum DefectStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  CLOSED
}

enum EvaluationType {
  PASS_FAIL
  RATING
  MEASUREMENT
}

// New Quality Control Models
model quality_inspections {
  id                String            @id @default(uuid())
  company_id        String
  inspection_number String
  inspection_type   InspectionType
  reference_type    String            // PRODUCT, ORDER, BATCH
  reference_id      String
  location_id       String?
  inspector_id      String
  template_id       String?
  scheduled_date    DateTime
  started_at        DateTime?
  completed_at      DateTime?
  status            InspectionStatus  @default(PENDING)
  overall_result    String?           // PASS, FAIL, CONDITIONAL
  quality_score     Float?
  inspector_notes   String?
  recommendations   String?
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt
  
  companies         companies         @relation(fields: [company_id], references: [id], onDelete: Cascade)
  inspector         users             @relation("InspectionInspector", fields: [inspector_id], references: [id])
  template          inspection_templates? @relation(fields: [template_id], references: [id])
  checkpoints       inspection_checkpoints[]
  
  @@unique([company_id, inspection_number])
  @@index([company_id, status])
  @@index([inspector_id])
  @@index([reference_type, reference_id])
}

model inspection_templates {
  id              String            @id @default(uuid())
  company_id      String
  name            String
  description     String?
  category        String            // INCOMING, IN_PROCESS, FINAL, RANDOM, CUSTOM
  applicable_to   String[]          // PRODUCTS, ORDERS, BATCHES
  passing_score   Float             @default(70)
  is_active       Boolean           @default(true)
  created_by      String
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt
  
  companies       companies         @relation(fields: [company_id], references: [id], onDelete: Cascade)
  creator         users             @relation("TemplateCreator", fields: [created_by], references: [id])
  checkpoints     template_checkpoints[]
  inspections     quality_inspections[]
  
  @@index([company_id, is_active])
}

model template_checkpoints {
  id              String            @id @default(uuid())
  template_id     String
  name            String
  description     String?
  evaluation_type EvaluationType
  is_required     Boolean           @default(true)
  order_index     Int
  created_at      DateTime          @default(now())
  
  template        inspection_templates @relation(fields: [template_id], references: [id], onDelete: Cascade)
  
  @@index([template_id, order_index])
}

model inspection_checkpoints {
  id              String            @id @default(uuid())
  inspection_id   String
  name            String
  description     String?
  evaluation_type EvaluationType
  result          String?           // PASS, FAIL, or rating value
  notes           String?
  photos          String[]
  order_index     Int
  created_at      DateTime          @default(now())
  
  inspection      quality_inspections @relation(fields: [inspection_id], references: [id], onDelete: Cascade)
  
  @@index([inspection_id, order_index])
}

model defect_comments {
  id              String            @id @default(uuid())
  defect_id       String
  user_id         String
  comment         String
  attachments     String[]
  created_at      DateTime          @default(now())
  
  defect          quality_defects   @relation(fields: [defect_id], references: [id])
  user            users             @relation("DefectCommentUser", fields: [user_id], references: [id])
  
  @@index([defect_id, created_at])
}

model inspection_metrics {
  id                  String      @id @default(uuid())
  company_id          String
  period_start        DateTime
  period_end          DateTime
  total_inspections   Int         @default(0)
  passed_inspections  Int         @default(0)
  failed_inspections  Int         @default(0)
  pass_rate           Float       @default(0)
  total_defects       Int         @default(0)
  critical_defects    Int         @default(0)
  avg_inspection_time Float?
  created_at          DateTime    @default(now())
  updated_at          DateTime    @updatedAt
  
  companies           companies   @relation(fields: [company_id], references: [id], onDelete: Cascade)
  
  @@unique([company_id, period_start, period_end])
  @@index([company_id, period_start])
}
